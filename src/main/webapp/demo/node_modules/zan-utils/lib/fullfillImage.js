(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(['module', 'exports', './browser/image'], factory);
  } else if (typeof exports !== "undefined") {
    factory(module, exports, require('./browser/image'));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod, mod.exports, global.image);
    global.fullfillImage = mod.exports;
  }
})(this, function (module, exports, _image) {
  'use strict';

  Object.defineProperty(exports, "__esModule", {
    value: true
  });

  var _image2 = _interopRequireDefault(_image);

  function _interopRequireDefault(obj) {
    return obj && obj.__esModule ? obj : {
      default: obj
    };
  }

  // _global.url Zan框架 和 iron 位置一致
  /**
   * 补全图片 url
   * @param  {string} url 欲补全的图片地址
   * @param {string} rule 规则，如 '!80x80q40+2x.jpg'
   * @description
   * ### rule可传参数含义
   * - !80x80 图片尺寸
   * - .q40 图片质量，默认75
   * - .+2x 图片是否放大2倍，适合retina屏幕，默认不放大
   * - .jpg 图片类型
   * @param {object} options 指定的url集合，默认使用window._global.url.imgqn，如果_global没有这个对象，可以自己指定一个
   * @return {string}     补全后的图片地址
   * @example
   * const url = 'http://img.yzcdn.cn/upload_files/2017/06/27/Fhgkb5fVQ5dM9DjS70lt-Ie5hnGb.jpg';
   * fullfillImage(url, '!50x50.jpg');
   * // => https://img.yzcdn.cn/upload_files/2017/06/27/Fhgkb5fVQ5dM9DjS70lt-Ie5hnGb.jpg?imageView2/2/w/50/h/50/q/75/format/webp
   * // 指定options
   * fullfillImage(url, '!50x50.jpg', { imgcdn: "https://img.yzcdn.cn" });
   */
  function fullfillImage(url, rule) {
    var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};

    if (!url) return;
    if (url.match(/^data:/i)) return url;

    if (!options.imgcdn && !options.imgqn) {
      var globalUrl = window._global.url || {};
      options.imgcdn = globalUrl.imgqn || globalUrl.imgcdn;
    }
    var imgcdn = options.imgcdn || options.imgqn || 'https://img.yzcdn.cn';

    // 使用过的域
    var DOMAIN_REG_ARRAY = [/^(https?:)?\/\/imgqn.koudaitong.com/, /^(https?:)?\/\/kdt-img.koudaitong.com/, /^(https?:)?\/\/img.yzcdn.cn/, /^(https?:)?\/\/dn-kdt-img.qbox.me/];

    rule = rule || '';

    for (var i = 0; i < DOMAIN_REG_ARRAY.length; i++) {
      // 并不是所有的域都支持HTTPS，所以把这些域替换成支持HTTPS的
      url = url.replace(DOMAIN_REG_ARRAY[i], imgcdn);
    }

    // 测试环境下的域名
    url = url.replace('imgqntest.koudaitong.com', 'dn-kdt-img-test.qbox.me');

    if (!url.match(/^(https?:)?\/\//i)) {
      url = imgcdn + '/' + url + rule;
    } else if (url.match(imgcdn) || url.match('dn-kdt-img-test.qbox.me')) {
      if (!url.match('!')) {
        url = '' + url + rule;
      }
    } else {
      return url;
    }

    // 暂时不使用 webp
    if (options.toWebp !== false) {
      // 尝试使用WEBP
      url = _image2['default'].toWebp(url);
    }
    return url;
  }
  exports['default'] = fullfillImage;
  module.exports = exports['default'];
});